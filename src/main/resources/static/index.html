<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        :root { --bg:#0b1220; --panel:#121a2b; --muted:#94a3b8; --text:#e2e8f0; --accent:#60a5fa; --ok:#22c55e; --err:#ef4444; }
        * { box-sizing: border-box; }
        body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#0b1220,#0e172a); color:var(--text); }
        header { padding:16px 24px; border-bottom:1px solid #1f2a44; position:sticky; top:0; background:rgba(11,18,32,.9); backdrop-filter:saturate(150%) blur(6px); }
        h1 { margin:0; font-size:20px; letter-spacing:.3px; }
        main { max-width:1100px; margin:0 auto; padding:24px; display:grid; grid-template-columns: 360px 1fr; gap:20px; }
        .card { background:var(--panel); border:1px solid #1f2a44; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
        .card h2 { margin:0; padding:14px 16px; font-size:15px; border-bottom:1px dashed #223055; color:#cbd5e1; }
        .card .body { padding:14px 16px; }
        label { display:block; margin:10px 0 6px; color:#cbd5e1; font-size:13px; }
        input, select, textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #223055; background:#0f172a; color:var(--text); outline:none; }
        input:focus, textarea:focus { border-color:#33518f; box-shadow:0 0 0 3px rgba(96,165,250,.15); }
        textarea { min-height:70px; resize:vertical; }
        .row { display:flex; gap:10px; align-items:center; }
        .row > * { flex:1; }
        button { border:1px solid #24467d; background:linear-gradient(180deg,#1d3b6a,#1a3057); padding:10px 12px; border-radius:10px; color:#dbeafe; cursor:pointer; font-weight:600; }
        button:hover { filter:brightness(1.05); }
        button.secondary { background:transparent; border-color:#334155; color:#cbd5e1; }
        button.danger { background:linear-gradient(180deg,#5b2031,#4b1a28); border-color:#7f1d1d; color:#fecaca; }
        .muted { color:var(--muted); font-size:12px; }
        .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
        .ok { background:var(--ok); }
        .warn { background:#f59e0b; }
        .err { background:var(--err); }
        .log { height:460px; overflow:auto; padding:0; margin:0; list-style:none; }
        .log li { padding:10px 12px; border-top:1px solid #1f2a44; }
        .msg { display:grid; grid-template-columns: 1fr auto; gap:6px; }
        .msg .meta { font-size:12px; color:#94a3b8; }
        .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #334155; font-size:11px; color:#cbd5e1; }
        details { margin-top:6px; }
        code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:.85rem; color:#e5e7eb; }
        pre { background:#0b1220; border:1px solid #1f2a44; padding:10px; border-radius:10px; overflow:auto; }
    </style>
</head>
<body>
<header>
    <h1>ICS344 Project</h1>
</header>

<main>
    <!-- LEFT: Controls -->
    <section class="card">
        <h2>Connection & Keys</h2>
        <div class="body">
            <label for="me">Your User ID</label>
            <div class="row">
                <input id="me" placeholder="e.g., alice" value="alice" />
                <button id="btnConnect">Connect</button>
                <button id="btnDisconnect" class="secondary">Disconnect</button>
            </div>
            <div style="margin-top:8px" class="muted">
                <span id="connDot" class="status-dot warn"></span><span id="connText">disconnected</span>
            </div>

            <hr style="margin:16px 0; border:0; border-top:1px dashed #223055"/>

            <div class="row">
                <button id="btnGenKeys">Generate Keys (2048)</button>
                <button id="btnGetPub" class="secondary">Get Public Key</button>
            </div>
            <pre id="pubOut" style="display:none; margin-top:10px"><code></code></pre>
        </div>
    </section>

    <!-- RIGHT: Messages -->
    <section class="card" style="grid-column:2 / span 1">
        <h2>Send Message</h2>
        <div class="body">
            <label for="to">Receiver ID</label>
            <input id="to" placeholder="e.g., bob" value="bob" />

            <label for="text">Message</label>
            <textarea id="text" placeholder="Type something nice…">HelloBob</textarea>

            <div class="row" style="margin-top:10px">
                <button id="btnSend">Send</button>
                <button id="btnClear" class="secondary">Clear Log</button>
            </div>
        </div>
    </section>

    <section class="card" style="grid-column:1 / span 2">
        <h2>Incoming Events & Decrypt Results</h2>
        <ul id="log" class="log"></ul>
    </section>
</main>

<script>
    const qs = (sel) => document.querySelector(sel);
    const me = qs('#me');
    const to = qs('#to');
    const text = qs('#text');
    const log = qs('#log');
    const connDot = qs('#connDot');
    const connText = qs('#connText');
    const pubOut = qs('#pubOut');

    let es = null; // EventSource instance

    function setConn(state) {
        connDot.classList.remove('ok','warn','err');
        if (state === 'open') { connDot.classList.add('ok'); connText.textContent = 'connected'; }
        else if (state === 'connecting') { connDot.classList.add('warn'); connText.textContent = 'connecting…'; }
        else { connDot.classList.add('err'); connText.textContent = 'disconnected'; }
    }

    function addLog({ title, badge, meta, plaintext, envelope, error }) {
        const li = document.createElement('li');
        const head = document.createElement('div');
        head.className = 'msg';
        head.innerHTML = `
        <div><strong>${title}</strong> ${badge ? `<span class="badge">${badge}</span>`:''}</div>
        <div class="meta">${meta || ''}</div>
      `;
        li.appendChild(head);

        if (plaintext !== undefined) {
            const p = document.createElement('div');
            p.innerHTML = `<div style="margin-top:6px">Plaintext: <code>${escapeHtml(plaintext)}</code></div>`;
            li.appendChild(p);
        }

        if (error) {
            const e = document.createElement('div');
            e.innerHTML = `<div style="margin-top:6px; color:#fecaca">Error: <code>${escapeHtml(error)}</code></div>`;
            li.appendChild(e);
        }

        if (envelope) {
            const det = document.createElement('details');
            const sum = document.createElement('summary');
            sum.textContent = 'Raw envelope';
            det.appendChild(sum);
            const pre = document.createElement('pre');
            const code = document.createElement('code');
            code.textContent = JSON.stringify(envelope, null, 2);
            pre.appendChild(code);
            det.appendChild(pre);
            li.appendChild(det);
        }

        log.insertBefore(li, log.firstChild);
    }

    function escapeHtml(s) { return (s+'').replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // Connect to SSE
    qs('#btnConnect').addEventListener('click', () => {
        if (es) { try { es.close(); } catch (_) {} }
        const userId = me.value.trim();
        if (!userId) return alert('Enter your user ID');

        setConn('connecting');
        es = new EventSource(`/api/chat/connect/${encodeURIComponent(userId)}`);

        es.addEventListener('open', () => setConn('open'));

        // The backend uses .name("message"), so listen for the custom event name "message".
        es.addEventListener('message', async (evt) => {
            try {
                const chat = JSON.parse(evt.data); // { senderId, receiverId, envelope, timestamp }
                // Immediately ask backend to decrypt
                const resp = await fetch('/api/crypto/decrypt', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ envelope: chat.envelope })
                });
                const out = await resp.json();
                if (out.status === 'OK') {
                    addLog({
                        title: `From ${chat.senderId} → ${chat.receiverId}`,
                        badge: 'decrypted',
                        meta: new Date().toLocaleString(),
                        plaintext: out.plaintext,
                        envelope: chat.envelope
                    });
                } else {
                    addLog({
                        title: `From ${chat.senderId} → ${chat.receiverId}`,
                        badge: 'decrypt error',
                        meta: new Date().toLocaleString(),
                        error: `${out.code}: ${out.message}`,
                        envelope: chat.envelope
                    });
                }
            } catch (e) {
                addLog({ title: 'Incoming message', badge: 'parse error', error: String(e) });
            }
        });

        es.addEventListener('error', (e) => {
            setConn('disconnected');
            // Keep the log readable
            addLog({ title:'SSE Error', badge:'connection', error:'Stream closed or network issue' });
            try { es.close(); } catch(_) {}
            es = null;
        });
    });

    qs('#btnDisconnect').addEventListener('click', () => { if (es) { es.close(); es = null; } setConn('disconnected'); });

    // Send message via query params as your backend expects currently
    qs('#btnSend').addEventListener('click', async () => {
        const senderId = me.value.trim();
        const receiverId = to.value.trim();
        const message = text.value;
        if (!senderId || !receiverId) return alert('Both sender and receiver are required');

        const params = new URLSearchParams({ senderId, receiverId, message });
        const r = await fetch(`/api/chat/send?${params.toString()}`, { method: 'POST' });
        if (r.ok) {
            addLog({ title: `Sent → ${receiverId}`, badge:'sent', meta:new Date().toLocaleString(), plaintext: message });
            text.select();
        } else {
            addLog({ title:'Send failed', badge:'http', error:`HTTP ${r.status}` });
        }
    });

    qs('#btnClear').addEventListener('click', () => { log.innerHTML = ''; });

    // Keys helpers (for convenience during demos)
    qs('#btnGenKeys').addEventListener('click', async () => {
        const userId = me.value.trim();
        if (!userId) return alert('Enter user ID');
        const r = await fetch('/api/keys/generate', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ userId, keySize: 2048 })
        });
        if (r.ok) {
            const j = await r.json();
            addLog({ title:`Keys generated for ${j.userId}`, badge:'keys', meta:j.createdAt });
        } else {
            addLog({ title:'Keygen failed', badge:'http', error:`HTTP ${r.status}` });
        }
    });

    qs('#btnGetPub').addEventListener('click', async () => {
        const userId = me.value.trim();
        if (!userId) return alert('Enter user ID');
        const r = await fetch(`/api/keys/${encodeURIComponent(userId)}/public`);
        if (r.ok) {
            const j = await r.json();
            pubOut.style.display = 'block';
            pubOut.querySelector('code').textContent = j.publicKeyPem || '(empty)';
        } else {
            pubOut.style.display = 'block';
            pubOut.querySelector('code').textContent = `HTTP ${r.status}`;
        }
    });

    // Default state
    setConn('disconnected');
</script>
</body>
</html>
